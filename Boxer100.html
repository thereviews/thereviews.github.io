<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Boxing Coach — BlazePose Selfie</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    margin:0; padding:0;
    background:#000; color:#fff;
    font-family:Arial, sans-serif;
    display:flex; flex-direction:column; align-items:center; 
    overflow:hidden;
  }
  #wrap{
    position:relative; width:100vw; max-width:450px; height:75vh;
    background:#000; overflow:hidden; border-radius:10px;
  }
  video, canvas{
    position:absolute; top:0; left:0;
    width:100%; height:100%; object-fit:cover;
  }
  #hud{
    position:absolute; top:0; left:0; width:100%;
    background:rgba(0,0,0,0.4); font-size:12px;
    display:flex; justify-content:space-between;
    padding:6px; box-sizing:border-box;
  }
  #alert{
    position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    font-size:16px; font-weight:bold; padding:5px 12px; border-radius:6px;
    background:rgba(255,0,0,0.7); display:none;
  }
  #controls{
    margin-top:10px; display:flex; gap:8px;
  }
  button{
    padding:8px 12px; border:none; border-radius:6px;
    background:#007AFF; color:#fff; font-weight:bold;
  }
</style>
</head>
<body>

<h3>AI Boxing Coach — BlazePose</h3>

<div id="wrap">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>

  <div id="hud">
    <div>Jabs: <span id="jabs">0</span></div>
    <div>Crosses: <span id="crosses">0</span></div>
    <div>Status: <span id="status">idle</span></div>
  </div>

  <div id="alert"></div>
</div>

<div id="controls">
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="reset">Reset</button>
</div>

<!-- BlazePose + Holistic -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>

<script>
(async ()=>{

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const statusEl=document.getElementById('status');
  const jabsEl=document.getElementById('jabs');
  const crossesEl=document.getElementById('crosses');
  const alertBox=document.getElementById('alert');

  const startBtn=document.getElementById('start');
  const stopBtn=document.getElementById('stop');
  const resetBtn=document.getElementById('reset');

  let jabs=0, crosses=0;
  let running=false;

  function coachVoice(msg){
    let speech = new SpeechSynthesisUtterance(msg);
    speech.lang="en-US"; speech.volume=1; speech.rate=1.05;
    window.speechSynthesis.speak(speech);
  }

  function showAlert(text,color){
    alertBox.style.display="block";
    alertBox.style.background=color;
    alertBox.innerText=text;
  }
  function hideAlert(){ alertBox.style.display="none"; }

  const holistic = new Holistic.Holistic({
    locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5/${file}`
  });

  holistic.setOptions({
    selfieMode:true,
    modelComplexity:0,     // Lite model (important for A04e)
    smoothLandmarks:true,
    minDetectionConfidence:0.55,
    minTrackingConfidence:0.55
  });

  holistic.onResults(results=>{
    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(results.image,0,0,canvas.width,canvas.height);

    // draw pose
    if(results.poseLandmarks){
      drawConnectors(ctx, results.poseLandmarks, Holistic.POSE_CONNECTIONS,{color:'#00FFFF',lineWidth:2});
      drawLandmarks(ctx, results.poseLandmarks,{color:'#00FFFF',radius:4});
    }

    analyzeBoxing(results);

    ctx.restore();
  });

  function analyzeBoxing(results){
    if(!results.poseLandmarks) return;

    let LM=results.poseLandmarks;
    let nose = LM[0];
    let lw = LM[15], rw = LM[16]; // wrists
    let ls = LM[11], rs = LM[12]; // shoulders

    // Guard Detection: wrists too low (below nose or too far)
    if(lw && rw && nose){
      if(lw.y > nose.y+0.06 || rw.y > nose.y+0.06){
        showAlert("Hands Up!", "rgba(255,0,0,0.7)");
        coachVoice("Hands up!");
      } else hideAlert();
    }

    // Punch Logic
    detectPunch(lw,ls,true);
    detectPunch(rw,rs,false);
  }

  let prevL=null, prevR=null;
  function detectPunch(wrist,shoulder,isLeft){
    if(!wrist||!shoulder) return;
    let dist = Math.hypot(wrist.x-shoulder.x, wrist.y-shoulder.y);
    if(isLeft){
      if(prevL && dist-prevL>0.04){ jabs++; jabsEl.innerText=jabs; coachVoice("Jab!"); }
      prevL=dist;
    } else {
      if(prevR && dist-prevR>0.04){ crosses++; crossesEl.innerText=crosses; coachVoice("Cross!"); }
      prevR=dist;
    }
  }

  startBtn.onclick=async()=>{
    startBtn.disabled=true; stopBtn.disabled=false;
    statusEl.innerText="Starting...";

    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    video.srcObject = stream;
    video.style.transform="scaleX(-1)";

    await new Promise(r=>video.onloadedmetadata=r);
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;

    const camera = new Camera(video,{
      onFrame:async()=>{ if(running) await holistic.send({image:video}); },
      width:video.videoWidth, height:video.videoHeight
    });

    running=true;
    camera.start();
    statusEl.innerText="Running";
  };

  stopBtn.onclick=()=>{
    running=false; hideAlert();
    startBtn.disabled=false; stopBtn.disabled=true;
    statusEl.innerText="Stopped";
  };

  resetBtn.onclick=()=>{
    jabs=crosses=0; jabsEl.innerText=0; crossesEl.innerText=0;
  };

})();
</script>
</body>
</html>
